# é€šç”¨ Shell è„šæœ¬å‡½æ•°åº“ (lib_utils.sh)

![version](https://img.shields.io/badge/version-1.4-blue)
![license](https://img.shields.io/badge/license-MIT-green)

ä¸€ä¸ªå¯é‡ç”¨çš„ Bash å‡½æ•°åº“ï¼Œæ—¨åœ¨ç®€åŒ–ã€æ ‡å‡†åŒ–å’ŒåŠ é€Ÿæ‚¨çš„ Shell è„šæœ¬å¼€å‘ã€‚é€šè¿‡å¼•å…¥ `lib_utils.sh`ï¼Œæ‚¨å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯é‡å¤ç¼–å†™åŸºç¡€åŠŸèƒ½ä»£ç ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **æ—¥å¿—ç³»ç»Ÿ**: æä¾› `info`, `success`, `warning`, `error`, `debug` äº”çº§å½©è‰²æ—¥å¿—è¾“å‡ºï¼Œä½¿è„šæœ¬è¾“å‡ºæ›´æ¸…æ™°ã€‚
- **è‡ªæ–‡æ¡£åŒ–**: å†…ç½® `help` å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‡½æ•°åˆ—è¡¨åŠå…¶è¯¦ç»†ç”¨æ³•å’Œç¤ºä¾‹ã€‚
- **ä¾èµ–è‡ªåŠ¨å¤„ç†**: `ensure_command` å’Œ `install_dependencies` å‡½æ•°å¯è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ç¼ºå¤±çš„å‘½ä»¤å’Œè½¯ä»¶åŒ…ï¼ˆæ”¯æŒ Debian/Ubuntu, CentOS/RHEL, Alpineï¼‰ã€‚
- **ç³»ç»Ÿä¿¡æ¯**: è½»æ¾è·å–æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€ç³»ç»Ÿæ¶æ„ã€å…¬ç½‘ IP ç­‰ä¿¡æ¯ã€‚
- **å¥å£®çš„é”™è¯¯å¤„ç†**: `error_exit` å‡½æ•°å¯ä¸­æ–­è„šæœ¬æ‰§è¡Œï¼Œé˜²æ­¢é”™è¯¯è”“å»¶ã€‚
- **å¸¸ç”¨å·¥å…·å°è£…**: å°è£…äº†è¯ä¹¦ç”³è¯·ã€æ–‡ä»¶å¤‡ä»½ã€æƒé™è®¾ç½®ã€éšæœºå­—ç¬¦ä¸²/UUIDç”Ÿæˆç­‰é«˜é¢‘æ“ä½œã€‚
- **è·¨å¹³å°å…¼å®¹**: å‡½æ•°åœ¨è®¾è®¡æ—¶è€ƒè™‘äº†ä¸åŒ Linux å‘è¡Œç‰ˆçš„å…¼å®¹æ€§ã€‚

## ç›®å½•

- [å®‰è£…ä¸ä½¿ç”¨](#-å®‰è£…ä¸ä½¿ç”¨)
- [å¿«é€Ÿå…¥é—¨ç¤ºä¾‹](#-å¿«é€Ÿå…¥é—¨ç¤ºä¾‹)
- [å‡½æ•°å‚è€ƒ](#-å‡½æ•°å‚è€ƒ)
  - [æ—¥å¿—ä¸æ¶ˆæ¯](#æ—¥å¿—ä¸æ¶ˆæ¯)
  - [ç³»ç»Ÿä¸ç½‘ç»œ](#ç³»ç»Ÿä¸ç½‘ç»œ)
  - [è¯ä¹¦ç®¡ç†](#è¯ä¹¦ç®¡ç†)
  - [æ–‡ä»¶ä¸ç›®å½•](#æ–‡ä»¶ä¸ç›®å½•)
  - [è½¯ä»¶åŒ…ç®¡ç†](#è½¯ä»¶åŒ…ç®¡ç†)
  - [è¿›ç¨‹ç®¡ç†](#è¿›ç¨‹ç®¡ç†)
  - [ç”¨æˆ·ç®¡ç†](#ç”¨æˆ·ç®¡ç†)
  - [å®‰å…¨ä¸æ ‡è¯†ç¬¦](#å®‰å…¨ä¸æ ‡è¯†ç¬¦)
- [å¦‚ä½•è´¡çŒ®](#-å¦‚ä½•è´¡çŒ®)
- [è®¸å¯è¯](#-è®¸å¯è¯)

## ğŸš€ å®‰è£…ä¸ä½¿ç”¨

1.  **ä¸‹è½½å‡½æ•°åº“æ–‡ä»¶**

    é€šè¿‡ `git` å…‹éš†:
    ```bash
    git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git
    ```
    æˆ–è€…ç›´æ¥ä¸‹è½½:
    ```bash
    curl -O https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/lib_utils.sh
    ```

2.  **åœ¨ä½ çš„è„šæœ¬ä¸­å¼•å…¥**

    åœ¨ä½ çš„ä¸»è„šæœ¬å¼€å¤´ï¼Œä½¿ç”¨ `source` å‘½ä»¤å¼•å…¥ `lib_utils.sh`ï¼š

    ```bash
    #!/bin/bash

    # å¼•å…¥å‡½æ•°åº“
    source ./lib_utils.sh

    # ç°åœ¨ä½ å¯ä»¥ç›´æ¥è°ƒç”¨åº“ä¸­çš„æ‰€æœ‰å‡½æ•°
    info_msg "è„šæœ¬å¯åŠ¨æˆåŠŸï¼Œå‡½æ•°åº“å·²åŠ è½½ã€‚"
    my_uuid=$(generate_uuid)
    success_msg "ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„ UUID: ${my_uuid}"
    ```

## ğŸ’¡ å¿«é€Ÿå…¥é—¨ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªåä¸º `setup_app.sh` çš„ç¤ºä¾‹è„šæœ¬ï¼Œå®ƒæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨æœ¬å‡½æ•°åº“æ¥å®Œæˆä¸€ç³»åˆ—å¸¸è§ä»»åŠ¡ã€‚

```bash
#!/bin/bash

# ======================================================
#            åº”ç”¨å®‰è£…è„šæœ¬ (setup_app.sh)
#  æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ lib_utils.sh æ¥ç®€åŒ–è„šæœ¬ç¼–å†™
# ======================================================

# å¼•å…¥å‡½æ•°åº“ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€€å‡º
if [ -f ./lib_utils.sh ]; then
    source ./lib_utils.sh
else
    echo "[é”™è¯¯] å‡½æ•°åº“ lib_utils.sh æœªæ‰¾åˆ°ï¼" >&2
    exit 1
fi

# --- ä¸»é€»è¾‘å¼€å§‹ ---

# 1. æ‰“å°æ¬¢è¿ä¿¡æ¯å¹¶æ£€æŸ¥ root æƒé™
info_msg "æ¬¢è¿ä½¿ç”¨åº”ç”¨å®‰è£…è„šæœ¬..."
_check_root || error_exit "æ­¤è„šæœ¬éœ€è¦ä»¥ root æƒé™è¿è¡Œã€‚"

# 2. è·å–å¹¶æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
os_info=$(get_os_info)
arch=$(get_system_arch)
info_msg "æ£€æµ‹åˆ°ç³»ç»Ÿ: ${os_info} (${arch})"

# 3. ç¡®ä¿å¿…è¦çš„å·¥å…·å·²å®‰è£… (ä¾‹å¦‚ï¼šjq)
info_msg "æ­£åœ¨æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–å·¥å…·..."
ensure_command "jq" "jq" || error_exit "å®‰è£… jq å¤±è´¥ã€‚"

# 4. ç”Ÿæˆä¸€ä¸ªéšæœºå¯†ç ç”¨äºæ•°æ®åº“
db_password=$(generate_random_string 16)
info_msg "ä¸ºæ•°æ®åº“ç”Ÿæˆäº†ä¸€ä¸ªéšæœºå¯†ç ã€‚"
# å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå®é™…ä½¿ç”¨ä¸­ä¸åº”ç›´æ¥æ‰“å°å¯†ç 
# success_msg "å¯†ç : ${db_password}" 

# 5. åˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·æ¥è¿è¡Œåº”ç”¨
info_msg "æ­£åœ¨ä¸ºåº”ç”¨åˆ›å»ºç³»ç»Ÿç”¨æˆ· 'apprunner'..."
create_system_user "apprunner"

# 6. å¤‡ä»½æ—§çš„é…ç½®æ–‡ä»¶
config_file="/etc/myapp/config.toml"
if [ -f "$config_file" ]; then
    info_msg "å‘ç°æ—§çš„é…ç½®æ–‡ä»¶ï¼Œæ­£åœ¨å¤‡ä»½..."
    backup_file "$config_file" "/opt/backups"
else
    warning_msg "æœªæ‰¾åˆ°æ—§çš„é…ç½®æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°çš„ã€‚"
    mkdir -p /etc/myapp
fi

# 7. åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ï¼ˆæ­¤å¤„ä¸ºä¼ªä»£ç ï¼‰
echo "# æ–°çš„é…ç½®æ–‡ä»¶" > "$config_file"
echo "database_password = \"${db_password}\"" >> "$config_file"
echo "server_id = \"$(generate_uuid)\"" >> "$config_file"

# 8. è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
info_msg "æ­£åœ¨ä¸ºåº”ç”¨ç›®å½• '/var/lib/myapp' è®¾ç½®æƒé™..."
mkdir -p /var/lib/myapp
set_directory_permissions "/var/lib/myapp" 750 640 "apprunner" "apprunner"

# 9. ä¸€åˆ‡é¡ºåˆ©ï¼Œæ‰“å°æˆåŠŸä¿¡æ¯
success_msg "åº”ç”¨ç¯å¢ƒé…ç½®å®Œæˆï¼"

exit 0
```

---

## ğŸ“š å‡½æ•°å‚è€ƒ

ä½¿ç”¨ `help <å‡½æ•°å>` å¯ä»¥è·å–æ›´è¯¦ç»†çš„å®æ—¶å¸®åŠ©ã€‚

### æ—¥å¿—ä¸æ¶ˆæ¯

-   `error_exit <message> [exit_code]`
    æ‰“å°çº¢è‰²é”™è¯¯æ¶ˆæ¯å¹¶é€€å‡ºè„šæœ¬ã€‚
-   `success_msg <message>`
    æ‰“å°ç»¿è‰²æˆåŠŸæ¶ˆæ¯ã€‚
-   `warning_msg <message>`
    æ‰“å°é»„è‰²è­¦å‘Šæ¶ˆæ¯ã€‚
-   `info_msg <message>`
    æ‰“å°è“è‰²ä¿¡æ¯æ¶ˆæ¯ã€‚
-   `debug_msg <message>`
    å½“ç¯å¢ƒå˜é‡ `DEBUG=1` æ—¶ï¼Œæ‰“å°ç´«è‰²è°ƒè¯•æ¶ˆæ¯ã€‚

### ç³»ç»Ÿä¸ç½‘ç»œ

-   `get_system_arch`
    è·å–ç³»ç»Ÿæ¶æ„ï¼Œå¦‚ `x86_64-linux`ã€‚
-   `get_os_info`
    è·å–ç³»ç»Ÿå‘è¡Œç‰ˆä¿¡æ¯ï¼Œå¦‚ `ubuntu 22.04` æˆ– `centos 7.9.2009`ã€‚
-   `get_latest_github_release <owner/repo>`
    è·å–æŒ‡å®š GitHub ä»“åº“çš„æœ€æ–°å‘å¸ƒç‰ˆæœ¬å·ã€‚
-   `check_network_connection`
    æ£€æŸ¥åˆ° `api.github.com` çš„ç½‘ç»œè¿é€šæ€§ã€‚
-   `get_public_ip`
    ä»å…¬å…±æœåŠ¡è·å–æœ¬æœºçš„å…¬ç½‘ IP åœ°å€ã€‚

### è¯ä¹¦ç®¡ç†

-   `install_acme_sh <email>`
    å®‰è£… acme.sh è¯ä¹¦ç”³è¯·å·¥å…·ã€‚
-   `issue_acme_cert <domain> <cert_path> <key_path> [reload_cmd] [owner] [group]`
    ä½¿ç”¨ acme.sh (standalone æ¨¡å¼) ç”³è¯· Let's Encrypt è¯ä¹¦å¹¶å®‰è£…ã€‚
-   `generate_self_signed_cert <domain> <cert_path> <key_path> [owner] [group]`
    ç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆæœŸä¸º10å¹´çš„è‡ªç­¾åè¯ä¹¦ã€‚

### æ–‡ä»¶ä¸ç›®å½•

-   `backup_file <file_path> [backup_dir]`
    å°†æ–‡ä»¶å¤‡ä»½åˆ°æŒ‡å®šç›®å½•ï¼ˆé»˜è®¤ä¸º `./backups`ï¼‰ï¼Œå¹¶é™„å¸¦æ—¶é—´æˆ³ã€‚
-   `set_directory_permissions <dir> [dir_mode] [file_mode] [owner] [group]`
    é€’å½’åœ°ä¸ºç›®å½•å’Œæ–‡ä»¶è®¾ç½®æƒé™åŠæ‰€æœ‰è€…ã€‚

### è½¯ä»¶åŒ…ç®¡ç†

-   `install_dependencies <pkg1> <pkg2> ...`
    ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨ï¼ˆ`apt`, `yum`, `apk`ï¼‰å®‰è£…ä¸€ä¸ªæˆ–å¤šä¸ªä¾èµ–åŒ…ã€‚
-   `ensure_command <command> [package_name]`
    ç¡®ä¿ä¸€ä¸ªå‘½ä»¤å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™å°è¯•å®‰è£…å¯¹åº”çš„åŒ…ã€‚

### è¿›ç¨‹ç®¡ç†

-   `is_process_running <process_name>`
    é€šè¿‡ `pgrep` æ£€æŸ¥ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚
-   `restart_service <service_name>`
    é€šè¿‡ `systemctl` æˆ– `service` å‘½ä»¤é‡å¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ã€‚

### ç”¨æˆ·ç®¡ç†

-   `create_system_user <username> [shell]`
    åˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·ï¼ˆ`useradd -r`ï¼‰ï¼Œé»˜è®¤ä¸º nologin shellã€‚

### å®‰å…¨ä¸æ ‡è¯†ç¬¦

-   `generate_random_string [length]`
    ä½¿ç”¨ `openssl` ç”Ÿæˆä¸€ä¸ªå®‰å…¨çš„ã€URLå‹å¥½çš„éšæœºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤32ä½ï¼‰ã€‚
-   `generate_uuid`
    ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„ v4 UUIDã€‚ä¼˜å…ˆä½¿ç”¨ `uuidgen`ï¼Œå¹¶æœ‰å¤šç§å¤‡é€‰æ–¹æ¡ˆã€‚
-   `validate_ip <ip_address>`
    éªŒè¯ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºåˆæ³•çš„ IPv4 åœ°å€æ ¼å¼ã€‚

## ğŸ¤ å¦‚ä½•è´¡çŒ®

æ¬¢è¿æ‚¨ä¸ºè¿™ä¸ªé¡¹ç›®åšå‡ºè´¡çŒ®ï¼

1.  **Fork** æœ¬ä»“åº“ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ (`git checkout -b feature/your-new-feature`)ã€‚
3.  æäº¤æ‚¨çš„ä¿®æ”¹ (`git commit -am 'Add some feature'`)ã€‚
4.  å°†æ‚¨çš„åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ (`git push origin feature/your-new-feature`)ã€‚
5.  åˆ›å»ºä¸€ä¸ªæ–°çš„ **Pull Request**ã€‚

å¦‚æœæ‚¨å‘ç°äº† Bug æˆ–æœ‰åŠŸèƒ½å»ºè®®ï¼Œè¯·éšæ—¶æäº¤ [Issues](https://github.com/YOUR_USERNAME/YOUR_REPO/issues)ã€‚

## Â© è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [MIT License](LICENSE) è®¸å¯è¯ã€‚
